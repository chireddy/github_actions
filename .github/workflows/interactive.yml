name: CI/CD Pipeline with Rework Pause

on:
  push:
    branches:
      - main

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run Tests
        run: echo "Running tests"
        #run: npm test # Replace with real test command

  deploy-staging:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Staging
        run: echo "Deploying to Staging..." # Replace with actual deploy command

  approval:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Wait for Manual Approval
        run: echo "Waiting for manual approval in GitHub UI"

  check-rework:
    needs: approval
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Check if rework is completed
        id: check
        run: |
          echo "🔎 Checking REWORK_DONE flag: ${{ vars.REWORK_DONE }}"
          if [[ "${{ vars.REWORK_DONE }}" == "true" ]]; then
            echo "✅ Rework complete. Proceeding with deployment."
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Rework not completed. Canceling workflow."
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  deploy-production:
    needs: check-rework
    if: needs.check-rework.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        run: echo "🚀 Deploying to Production..." # Replace with actual deploy command
